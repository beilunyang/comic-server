{"version":3,"sources":["../../src/routes/privilege.js"],"names":["sclient","db","showFriendlyErrorStack","on","err","console","error","message","ensureLogin","ctx","next","url","excludeUrls","excludeUrl","indexOf","session_id","header","authorization","throw","openid","get","state"],"mappings":";;;;;;;AAAA;;;;AACA;;;;;;AAEA,MAAMA,UAAU,sBAAU,EAAEC,IAAI,CAAN,EAASC,wBAAwB,IAAjC,EAAV,CAAhB;AACAF,QAAQG,EAAR,CAAW,OAAX,EAAoBC,OAAOC,QAAQC,KAAR,CAAcF,IAAIG,OAAlB,CAA3B;;AAEO,MAAMC,oCAAc,OAAOC,GAAP,EAAYC,IAAZ,KAAqB;AAC9C,QAAMC,MAAMF,IAAIE,GAAhB;AACA,QAAMC,cAAc,iBAAOA,WAA3B;AACA,OAAK,MAAMC,UAAX,IAAyBD,WAAzB,EAAsC;AACpC,QAAID,IAAIG,OAAJ,CAAYD,UAAZ,MAA4B,CAAhC,EAAmC;AACjC,aAAO,MAAMH,MAAb;AACD;AACF;;AAED,QAAMK,aAAaN,IAAIO,MAAJ,CAAWC,aAA9B;AACA,MAAI,CAACF,UAAL,EAAiB;AACfN,QAAIS,KAAJ,CAAU,GAAV,EAAe,MAAf;AACD,GAFD,MAEO;AACL,UAAMC,SAAS,MAAMnB,QAAQoB,GAAR,CAAYL,UAAZ,CAArB;AACA,QAAII,MAAJ,EAAY;AACVV,UAAIY,KAAJ,CAAUF,MAAV,GAAmBA,MAAnB;AACA,YAAMT,MAAN;AACD,KAHD,MAGO;AACLD,UAAIS,KAAJ,CAAU,GAAV,EAAe,MAAf;AACD;AACF;AACF,CArBM","file":"privilege.js","sourcesContent":["import Redis from 'ioredis';\nimport config from '../config';\n\nconst sclient = new Redis({ db: 1, showFriendlyErrorStack: true });\nsclient.on('error', err => console.error(err.message));\n\nexport const ensureLogin = async (ctx, next) => {\n  const url = ctx.url;\n  const excludeUrls = config.excludeUrls;\n  for (const excludeUrl of excludeUrls) {\n    if (url.indexOf(excludeUrl) === 0) {\n      return await next();\n    }\n  }\n\n  const session_id = ctx.header.authorization;\n  if (!session_id) {\n    ctx.throw(401, '验证失败');\n  } else {\n    const openid = await sclient.get(session_id);\n    if (openid) {\n      ctx.state.openid = openid;\n      await next();\n    } else {\n      ctx.throw(401, '验证失败');\n    }\n  }\n};\n\n\n"]}